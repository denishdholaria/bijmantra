# Backend code-500 Errors Investigation Report

**Date**: January 3, 2026
**Session**: 58 - SAHASRABHUJA JavaScript Error Fix
**Status**: Investigation Complete

---

## Summary

During the SAHASRABHUJA protocol execution, the E2E JavaScript error scan identified several pages receiving 500 Internal Server Error responses from the backend API.

---

## Affected Endpoints

| Frontend Page       | API Endpoint                        | Error Type                | Status              |
| ------------------- | ----------------------------------- | ------------------------- | ------------------- |
| `/apex-analytics` | `GET /api/v2/analytics`           | 500 Internal Server Error | üî¥ Needs Fix        |
| `/auditlog`       | `GET /api/v2/audit/security`      | 401 ‚Üí 500 cascade        | üü° Auth Required    |
| `/seed-bank`      | `GET /api/v2/seed-bank/dashboard` | 404 Not Found             | üü° Endpoint Missing |

---

## Root Cause Analysis

### 1. `/api/v2/analytics` - 500 Error

**File**: `backend/app/api/v2/analytics.py`

**Observed Behavior**: Endpoint returns 500 Internal Server Error even with valid authentication.

**Hypothesis** (requires backend log inspection):

- Database query failure in `get_real_summary()` function
- Possible issue with `org_filter()` lambda when `org_id` is None
- The filter `org_filter(Model)` returns `True` (boolean) instead of a SQLAlchemy filter expression when `org_id` is None

**Code Evidence** (lines 107-112):

```python
def org_filter(model):
    if org_id:
        return model.organization_id == org_id
    return True  # ‚Üê Returns boolean, not SQLAlchemy expression
```

**Risk**: When `org_id` is None, `select(...).where(True)` may cause SQLAlchemy to fail.

**Recommended Fix**:

```python
def org_filter(model):
    if org_id:
        return model.organization_id == org_id
    return True == True  # SQLAlchemy literal expression
    # OR: return text("1=1")
```

---

### 2. `/api/v2/audit/security` - Auth Required

**File**: `backend/app/api/v2/security_audit.py`

**Observed Behavior**: Returns 401 "Not authenticated" without token, which is expected. The 500 error seen in E2E tests may be due to:

- Rate limiting blocking test authentication
- Token not being passed correctly in test context

**Status**: Not a bug - authentication is working as designed.

---

### 3. `/api/v2/seed-bank/dashboard` - 404 Not Found

**Observed Behavior**: Endpoint does not exist.

**Evidence**:

- `curl http://localhost:8000/api/v2/seed-bank/dashboard` returns `{"detail":"Not Found"}`
- The seed-bank module has `/api/v2/seed-bank/accessions`, `/api/v2/seed-bank/vaults`, etc. but no `/dashboard` endpoint

**Status**: Frontend page may be calling a non-existent endpoint. The page likely works by aggregating data from multiple endpoints.

---

## Non-Error Issues (Timeouts)

The following pages timed out during E2E testing but are not 500 errors:

| Page                    | Reason                             |
| ----------------------- | ---------------------------------- |
| `/pedigree-3d`        | Heavy Three.js 3D rendering        |
| `/breeding-simulator` | Heavy Three.js 3D rendering        |
| `/earth-systems`      | Multiple API calls + map rendering |
| `/irrigation`         | Multiple API calls                 |
| `/commercial`         | Multiple API calls                 |

These are performance issues, not errors. The pages eventually load but exceed the 30-second `networkidle` timeout.

---

## Recommendations

### Priority 1: Fix Analytics Endpoint

- Update `org_filter()` in `backend/app/api/v2/analytics.py` to return proper SQLAlchemy expression
- Add error handling with proper logging

### Priority 2: Add Seed Bank Dashboard Endpoint (Optional)

- Create `/api/v2/seed-bank/dashboard` endpoint if needed
- Or update frontend to not call this endpoint

### Priority 3: Performance Optimization

- Consider lazy loading for Three.js pages
- Add loading states for heavy pages

---

## Verification Commands

```bash
# Test analytics endpoint
curl -s -H "Authorization: Bearer $TOKEN" http://localhost:8000/api/v2/analytics

# Test audit endpoint
curl -s -H "Authorization: Bearer $TOKEN" http://localhost:8000/api/v2/audit/security

# Check available seed-bank endpoints
curl -s http://localhost:8000/openapi.json | jq '.paths | keys | map(select(contains("seed-bank")))'
```

---

*Report generated by SAHASRABHUJA Protocol - Session 58*
